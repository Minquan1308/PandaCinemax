@model List<DoAnCoSoTL.Models.Seat>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
@{
    ViewData["Title"] = "Chọn ghế";
    var selectedSeatIds = ViewData["SelectedSeatIds"] as List<int> ?? new List<int>();
    int row1 = ViewBag.Row ?? 0; // Sử dụng kiểu int để tránh lỗi
    int number1 = ViewBag.Number ?? 0; // Sử dụng kiểu int để tránh lỗi
    var movieId = ViewData["MovieId"];
}

<!-- Thông tin thêm, ẩn mặc định -->
<div class="movie-info">
    <p class="info room-info">Phòng @ViewData["RoomId"]</p>
    <p class="info">Phim: @ViewData["MovieName"]</p>
    <p class="info">Khung giờ: @ViewData["TimeSlot"]</p>
    <div id="ticketPrice" class="info">Giá vé: @ViewBag.TicketPrice VND</div>
</div>

<div class="screen-divider">
    <hr class="divider-line">
    <div class="screen-text">Màn hình</div>
</div>

<div class="seat-layout">
    @for (int row = 1; row <= row1; row++)
    {
        <div class="seat-row">
            @for (int seatNumber = 1; seatNumber <= number1; seatNumber++)
            {
                string seatCode = $"{(char)('A' + row - 1)}{seatNumber}";
                var seat = Model.FirstOrDefault(s => s.SeatCode == seatCode);
                var isAvailable = seat != null && seat.IsAvailable;
                var isSelected = selectedSeatIds.Contains(seat.Id);

                <button class="seat @(isAvailable ? (isSelected ? "selected" : "") : "gray disabled")" data-seat-id="@seat.Id" data-seat-code="@seatCode">
                    <span class="seat-text">@seatCode</span>
                </button>
            }
        </div>
    }
</div>

<div class="legend" style="margin-bottom: 20px;">
    <div class="legend-item">
        <div class="seat-legend pink"></div>
        <span>Ghế đã chọn</span>
    </div>
    <div class="legend-item">
        <div class="seat-legend white"></div>
        <span>Ghế trống</span>
    </div>
    <div class="legend-item">
        <div class="seat-legend gray"></div>
        <span>Ghế đã được đặt</span>
    </div>
</div>

<div id="selectedSeats" class="info">Số ghế đã chọn:</div> <!-- Phần tử để hiển thị số ghế đã chọn -->

<form asp-area="" asp-controller="SeatBookingCart" asp-action="Index" method="get">
    <input type="hidden" name="roomId" value="@ViewData["RoomId"]" />
    <input type="hidden" name="screeningId" value="@ViewData["ScreeningId"]" />
    <input type="hidden" name="timeSlot" value="@ViewData["TimeSlot"]" />
    <input type="hidden" name="movieId" value="@movieId" />
    <input type="hidden" id="selectedSeatIdsInput" name="selectedSeatIds" value="@string.Join(",", selectedSeatIds)" />
    <button type="submit" class="btn btn-primary btn-purchase">Mua vé</button>
</form>

<div id="totalPrice" class="info">Tổng tiền: 0 VND</div>
<a href="@Url.Action("ClearCart", "SeatBookingCart", new { movieId = ViewData["MovieId"] })" class="btn btn-secondary btn-back">Trở về</a>

<script>
    $(document).ready(function () {

        $('.seat').click(function (event) {
            var isAvailable = !$(this).hasClass('gray');
            var seatId = $(this).data('seat-id');

            if (isAvailable) {
                $(this).toggleClass('selected');
                if ($(this).hasClass('selected')) {
                    addToCart(seatId);
                } else {
                    removeFromCart(seatId);
                }
            }
            event.preventDefault();
            updateTotalPrice();
            updateSelectedSeats();
        });

        function addToCart(seatId) {
            $.post('/SeatBookingCart/AddToCart', { seatId: seatId }, function () {
                // Do nothing after adding to cart
            });
        }

        function removeFromCart(seatId) {
            $.post('/SeatBookingCart/RemoveFromCart', { seatId: seatId }, function () {
                // Handle result from server if needed
            });
        }

        function updateTotalPrice() {
            var selectedSeatCount = $('.seat.selected').length;
            var ticketPrice = parseFloat($('#ticketPrice').text().replace('Giá vé: ', '').replace(' VND', ''));
            var totalPrice = selectedSeatCount * ticketPrice;
            $('#totalPrice').text('Tổng tiền: ' + totalPrice.toLocaleString('vi-VN') + ' VND');
        }

        function updateSelectedSeats() {
            var selectedSeats = [];
            $('.seat.selected').each(function () {
                var seatText = $(this).find('.seat-text').text();
                selectedSeats.push(seatText);
            });
            $('#selectedSeats').text('Số ghế đã chọn: ' + selectedSeats.join(', '));

            // Update hidden input with selected seat IDs
            var selectedSeatIds = $('.seat.selected').map(function () {
                return $(this).data('seat-id');
            }).get();
            $('#selectedSeatIdsInput').val(selectedSeatIds.join(','));
        }
    });
</script>

<style>
    body {
        font-family: 'Arial', sans-serif;
        background-color: #f8f9fa;
        color: #343a40;
        margin: 0;
        padding: 0;
    }

    .title {
        text-align: center;
        font-size: 2.5rem;
        color: #007bff;
        margin-top: 20px;
    }

    .info {
        text-align: center;
        font-size: 1.5rem;
        margin-bottom: 10px;
    }

    .room-info {
        font-size: 2.5rem;
        font-weight: bold;
    }

    .screen-divider {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        margin-top: 30px;
    }

    .divider-line {
        width: 300px;
        border: none;
        border-top: 2px solid #000;
        margin-top: 10px;
    }

    .screen-text {
        font-weight: bold;
        margin-top: -30px;
        margin-bottom: 30px;
        font-size: 2rem;
    }

    .seat-layout {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }

    .seat-row {
        display: flex;
        gap: 10px; /* Điều chỉnh khoảng cách giữa các ghế */
        align-items: center;
    }

    .seat {
        width: 50px; /* Điều chỉnh kích thước ghế */
        height: 50px; /* Điều chỉnh kích thước ghế */
        border: 1px solid #000;
        border-radius: 10px;
        background-color: #fff;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        font-size: 1.5rem; /* Điều chỉnh kích thước chữ */
        transition: background-color 0.3s, box-shadow 0.3s;
    }

        .seat:hover {
            background-color: #add8e6;
            box-shadow: 0 0 15px rgba(173, 216, 230, 0.75);
        }

        .seat.selected {
            background-color: pink;
            box-shadow: 0 0 15px rgba(255, 192, 203, 0.75);
        }

        .seat.gray.disabled {
            background-color: gray;
            pointer-events: none;
        }

    .seat-text {
        font-size: 1.5rem; /* Điều chỉnh kích thước chữ */
    }

    .legend {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 20px;
    }

    .legend-item {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .seat-legend {
        width: 30px;
        height: 30px;
        border: 1px solid #000;
        border-radius: 10px;
    }

        .seat-legend.pink {
            background-color: pink;
        }

        .seat-legend.white {
            background-color: #fff;
        }

        .seat-legend.gray {
            background-color: gray;
        }

    #totalPrice {
        text-align: center;
        font-size: 1.8rem;
        margin-top: 20px;
        font-weight: bold;
    }

    #selectedSeats {
        text-align: center;
        font-size: 1.8rem;
        margin-top: 10px;
    }

    .btn {
        font-size: 1.5rem;
        padding: 10px 20px;
        margin-top: 20px;
        display: block;
        margin-left: auto;
        margin-right: auto;
        border: none;
        border-radius: 5px;
        transition: background-color 0.3s, box-shadow 0.3s;
    }

    .btn-back {
        background-color: #6c757d;
        color: white;
    }

        .btn-back:hover {
            background-color: #5a6268;
            box-shadow: 0 0 15px rgba(108, 117, 125, 0.75);
        }

    .btn-purchase {
        background-color: #007bff;
        color: white;
    }

        .btn-purchase:hover {
            background-color: #0056b3;
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.75);
        }

    .btn-info {
        background-color: #17a2b8;
        color: white;
    }

        .btn-info:hover {
            background-color: #138496;
            box-shadow: 0 0 15px rgba(23, 162, 184, 0.75);
        }
</style>